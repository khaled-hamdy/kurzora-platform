// ==================================================================================
// ğŸ¯ SESSION #310: SCANNING CONFIGURATION - MODULAR ARCHITECTURE COMPONENT
// ==================================================================================
// ğŸš¨ PURPOSE: Extract scanning and timeframe configuration into isolated, configurable module
// ğŸ›¡ï¸ ANTI-REGRESSION MANDATE: ALL Session #151-185 + #301-309B functionality preserved EXACTLY
// ğŸ“ SESSION #310 EXTRACTION: Moving configuration constants from 1600-line monolith to modular architecture
// ğŸ”§ PRESERVATION: Session #185 400-day range + Session #151-185 timeframe weights + all scanning parameters
// ğŸš¨ CRITICAL SUCCESS: Maintain identical scanning behavior (100% exact configuration)
// âš ï¸ PROTECTED LOGIC: All timeframe weights, backtest mode, date calculations preserved exactly
// ğŸ–ï¸ SCANNING CONFIGURATION: Professional parameter management with institutional settings
// ğŸ“Š MODULAR INTEGRATION: Compatible with all Session #301-309B extracted components
// ğŸ† TESTING REQUIREMENT: Extracted module must produce identical configuration values
// ğŸš€ PRODUCTION IMPACT: Enable AI parameter optimization while preserving institutional-grade settings
// ==================================================================================

/**
 * ğŸ”§ TIMEFRAME CONFIGURATION INTERFACE - SESSION #310 STRUCTURE
 * ğŸ¯ PURPOSE: Define structure for timeframe analysis configuration
 * ğŸ”§ SESSION #151-185 COMPLIANCE: Preserves exact timeframe weights and periods from original system
 * ğŸ›¡ï¸ INSTITUTIONAL STANDARDS: Professional timeframe analysis requirements
 * ğŸ“Š PRODUCTION READY: Type-safe configuration structure for multi-timeframe analysis
 */
export interface TimeframeConfig {
  weight: number; // Weighting factor for timeframe in final score
  periods: number; // Number of data periods required for analysis
  description: string; // Human-readable description of timeframe purpose
}

/**
 * ğŸ”§ SCANNING SETTINGS INTERFACE - SESSION #310 CONFIGURATION STRUCTURE
 * ğŸš¨ PURPOSE: Comprehensive scanning configuration for signal generation
 * ğŸ”§ SESSION #151-185 COMPLIANCE: Supports all existing scanning parameters
 * ğŸ“Š AI OPTIMIZATION READY: Structured for future AI parameter modification
 */
export interface ScanningSettings {
  useBacktest: boolean;
  testStocks: string[];
  timeframeConfig: Record<string, TimeframeConfig>;
  dateRangeSettings: {
    backtestStart: string;
    backtestEnd: string;
    calendarDays: number;
  };
}

/**
 * ğŸ”§ SCANNING CONFIGURATION MANAGER - SESSION #310 MODULAR EXTRACTION
 * ğŸš¨ CRITICAL EXTRACTION: Moving scanning configuration from 1600-line monolith
 * ğŸ›¡ï¸ ANTI-REGRESSION: ALL Session #151-185 + #301-309B configuration preserved EXACTLY
 * ğŸ¯ PURPOSE: Centralized scanning and timeframe configuration management
 * ğŸ”§ SESSION #185 PRESERVATION: 400-day extended range configuration maintained
 * ğŸš€ SESSION #151-185 PRESERVATION: All timeframe weights and periods preserved exactly
 * ğŸ“Š PRODUCTION INTEGRATION: Professional configuration management with comprehensive logging
 * ğŸ–ï¸ AI OPTIMIZATION READY: Structured for future AI parameter optimization
 */
export class ScanningConfiguration {
  private settings: ScanningSettings;

  /**
   * ğŸ—ï¸ SCANNING CONFIGURATION CONSTRUCTOR - SESSION #310 INITIALIZATION
   * ğŸ¯ PURPOSE: Initialize scanning configuration with Session #151-185 preserved values
   * ğŸ”§ SESSION #151-185 PRESERVED: Exact configuration values from original system
   * ğŸ›¡ï¸ INSTITUTIONAL STANDARDS: Professional scanning configuration maintained exactly
   */
  constructor() {
    console.log(
      `ğŸ”§ [SESSION_310_CONFIG] Initializing scanning configuration with Session #151-185 preserved values`
    );

    // ğŸš¨ SESSION #151-185 PRESERVED EXACTLY: Timeframe configuration
    // ğŸ”§ SESSION #310 EXTRACTION: Moved from index.ts TIMEFRAME_CONFIG constant
    this.settings = {
      useBacktest: true, // ğŸ§ª SESSION #321 TEST: Enable verified historical data
      testStocks: ["AAPL", "MSFT", "GOOGL", "JPM", "JNJ"], // ğŸ§ª SESSION #153 PRESERVED: Debug stocks for testing
      timeframeConfig: {
        "1H": {
          weight: 0.4, // ğŸš¨ SESSION #151-185 PRESERVED: 40% weight for short-term momentum
          periods: 50, // ğŸ”§ SESSION #151-185 PRESERVED: 50 periods for technical indicators
          description: "Short-term momentum analysis", // ğŸ¯ SESSION #151-185 PRESERVED: Analysis purpose
        },
        "4H": {
          weight: 0.3, // ğŸš¨ SESSION #151-185 PRESERVED: 30% weight for medium-term trend
          periods: 50, // ğŸ”§ SESSION #151-185 PRESERVED: 50 periods for technical indicators
          description: "Medium-term trend confirmation", // ğŸ¯ SESSION #151-185 PRESERVED: Analysis purpose
        },
        "1D": {
          weight: 0.2, // ğŸš¨ SESSION #151-185 PRESERVED: 20% weight for long-term pattern
          periods: 50, // ğŸ”§ SESSION #151-185 PRESERVED: 50 periods for technical indicators
          description: "Long-term pattern analysis", // ğŸ¯ SESSION #151-185 PRESERVED: Analysis purpose
        },
        "1W": {
          weight: 0.1, // ğŸš¨ SESSION #151-185 PRESERVED: 10% weight for market cycle context
          periods: 50, // ğŸ”§ SESSION #151-185 PRESERVED: 50 periods for technical indicators
          description: "Market cycle context", // ğŸ¯ SESSION #151-185 PRESERVED: Analysis purpose
        },
      },
      dateRangeSettings: {
        backtestStart: "2024-05-06", // ğŸ§ª SESSION #152 PRESERVED: Verified backtest start date
        backtestEnd: "2024-06-14", // ğŸ§ª SESSION #152 PRESERVED: Verified backtest end date
        calendarDays: 400, // ğŸš€ SESSION #185 PRESERVED: Extended 400-day range for reliable multi-timeframe data
      },
    };

    console.log(
      `âœ… [SESSION_310_CONFIG] Scanning configuration initialized with Session #151-185 preserved settings`
    );
  }

  /**
   * ğŸ”§ GET USE BACKTEST - SESSION #310 BACKTEST MODE ACCESS
   * ğŸ¯ PURPOSE: Provide backtest mode setting for market data selection
   * ğŸ›¡ï¸ PRESERVATION: Maintains Session #152 backtest toggle functionality exactly
   * ğŸ“Š USAGE: Used by main processing loop for data source selection
   */
  getUseBacktest(): boolean {
    return this.settings.useBacktest;
  }

  /**
   * ğŸ§ª GET TEST STOCKS - SESSION #310 DEBUG STOCKS ACCESS
   * ğŸ¯ PURPOSE: Provide test stock list for debugging and development
   * ğŸ›¡ï¸ PRESERVATION: Maintains Session #153 test stocks exactly
   * ğŸ“Š USAGE: Used for development and testing purposes
   */
  getTestStocks(): string[] {
    return [...this.settings.testStocks]; // Return copy to prevent modification
  }

  /**
   * ğŸ”§ GET TIMEFRAME CONFIG - SESSION #310 TIMEFRAME CONFIGURATION ACCESS
   * ğŸ¯ PURPOSE: Provide complete timeframe configuration for multi-timeframe analysis
   * ğŸ›¡ï¸ PRESERVATION: Maintains Session #151-185 timeframe weights and periods exactly
   * ğŸ“Š USAGE: Used by TimeframeDataCoordinator and signal scoring calculations
   */
  getTimeframeConfig(): Record<string, TimeframeConfig> {
    return JSON.parse(JSON.stringify(this.settings.timeframeConfig)); // Deep copy to prevent modification
  }

  /**
   * ğŸš€ GET DATE RANGES - SESSION #310 DATE CALCULATION
   * ğŸš¨ EXTRACTED FROM: index.ts getDateRanges() function
   * ğŸ›¡ï¸ PRESERVATION: ALL Session #185 + #152 date calculation logic preserved EXACTLY
   * ğŸ¯ PURPOSE: Calculate appropriate date ranges for market data fetching
   * ğŸ”§ SESSION #185 PRESERVED: 400-day extended range for reliable multi-timeframe data
   * ğŸ§ª SESSION #152 PRESERVED: Backtest mode support maintained exactly
   */
  getDateRanges(): { recent: { start: string; end: string } } {
    if (this.settings.useBacktest) {
      console.log(
        `ğŸ”„ [SESSION_310_CONFIG] BACKTEST MODE ACTIVE: Using verified historical data`
      );
      console.log(
        `ğŸ“… [SESSION_310_CONFIG] Backtest Date Range: ${this.settings.dateRangeSettings.backtestStart} to ${this.settings.dateRangeSettings.backtestEnd}`
      );
      return {
        recent: {
          start: this.settings.dateRangeSettings.backtestStart,
          end: this.settings.dateRangeSettings.backtestEnd,
        },
      };
    } else {
      const now = new Date();
      const today = now.toISOString().split("T")[0];

      // ğŸš€ SESSION #185 CRITICAL DATA RANGE FIX: Extended from 150 to 400 calendar days for 4H + Weekly reliability
      const calendarDaysAgo = new Date(
        now.getTime() -
          this.settings.dateRangeSettings.calendarDays * 24 * 60 * 60 * 1000
      );
      const recentStartDate = calendarDaysAgo.toISOString().split("T")[0];

      console.log(
        `ğŸ“ˆ [SESSION_310_CONFIG] LIVE MODE ACTIVE: Using SESSION #185 enhanced ${this.settings.dateRangeSettings.calendarDays}-day rolling window for reliable multi-timeframe data`
      );
      console.log(
        `ğŸ“… [SESSION_310_CONFIG] SESSION #185 Enhanced Date Range: ${recentStartDate} to ${today} (${this.settings.dateRangeSettings.calendarDays} calendar days ensures sufficient data for all timeframes)`
      );
      console.log(
        `ğŸ”§ [SESSION_310_CONFIG] SESSION #185 DATA RANGE FIX: Extended window solves 4H and Weekly data availability limitations`
      );
      console.log(
        `ğŸ“Š [SESSION_310_CONFIG] SESSION #185 CALCULATION: ${this.settings.dateRangeSettings.calendarDays} calendar days - 46 weekend days - 27 holidays = ~327 trading days (abundant for all technical indicators)`
      );
      console.log(
        `ğŸ¯ [SESSION_310_CONFIG] SESSION #185 EXPECTED IMPROVEMENT: 4H: 50+ periods (vs 16), Weekly: 30+ periods (vs 11)`
      );

      return {
        recent: {
          start: recentStartDate,
          end: today,
        },
      };
    }
  }

  /**
   * ğŸ”§ SET USE BACKTEST - SESSION #310 AI OPTIMIZATION READY
   * ğŸ¯ PURPOSE: Allow AI to modify backtest mode for optimization
   * ğŸš¨ AI READY: Enable future AI parameter optimization
   * ğŸ“Š USAGE: Future AI optimization of scanning parameters
   */
  setUseBacktest(useBacktest: boolean): void {
    console.log(
      `ğŸ”§ [SESSION_310_CONFIG] Setting backtest mode: ${useBacktest}`
    );
    this.settings.useBacktest = useBacktest;
  }

  /**
   * ğŸš€ SET CALENDAR DAYS - SESSION #310 AI OPTIMIZATION READY
   * ğŸ¯ PURPOSE: Allow AI to optimize date range for different market conditions
   * ğŸš¨ AI READY: Enable future AI parameter optimization of data range
   * ğŸ“Š USAGE: Future AI optimization of data sufficiency vs processing speed
   */
  setCalendarDays(calendarDays: number): void {
    console.log(
      `ğŸ”§ [SESSION_310_CONFIG] Setting calendar days: ${calendarDays}`
    );
    this.settings.dateRangeSettings.calendarDays = calendarDays;
  }

  /**
   * ğŸ”§ GET FULL SETTINGS - SESSION #310 COMPLETE CONFIGURATION ACCESS
   * ğŸ¯ PURPOSE: Provide complete configuration object for advanced usage
   * ğŸ›¡ï¸ PRESERVATION: Returns deep copy to prevent external modification
   * ğŸ“Š USAGE: Used for configuration validation and AI optimization analysis
   */
  getFullSettings(): ScanningSettings {
    return JSON.parse(JSON.stringify(this.settings)); // Deep copy to prevent modification
  }

  /**
   * ğŸ“Š GET CONFIGURATION NAME - SESSION #310 MODULAR IDENTIFICATION
   * ğŸ¯ PURPOSE: Identify this configuration module for logging and debugging
   * ğŸ”§ USAGE: Used by orchestrator for module tracking and error reporting
   * ğŸ›¡ï¸ SESSION #301-309B COMPATIBILITY: Follows same naming pattern as other modular components
   */
  getName(): string {
    return "ScanningConfiguration";
  }
}

/**
 * ğŸ”§ SCANNING CONFIGURATION HELPER FUNCTIONS - SESSION #310 UTILITY FUNCTIONS
 * ğŸ¯ PURPOSE: Provide configuration access in original Edge Function format for backward compatibility
 * ğŸ”§ BRIDGE FUNCTIONS: Converts modular configuration back to original constant format
 * ğŸ›¡ï¸ ANTI-REGRESSION: Maintains exact return format expected by main processing loop
 * ğŸ“Š SESSION #151-185 PRESERVED: All scanning configuration maintained exactly
 */

// Global configuration instance for backward compatibility
const globalScanningConfig = new ScanningConfiguration();

/**
 * ğŸ”§ GET USE BACKTEST HELPER - SESSION #310 BACKWARD COMPATIBILITY
 * ğŸ¯ PURPOSE: Provide USE_BACKTEST constant replacement for main processing loop
 * ğŸ›¡ï¸ ANTI-REGRESSION: Maintains exact return value expected by index.ts
 */
export function getUseBacktest(): boolean {
  return globalScanningConfig.getUseBacktest();
}

/**
 * ğŸ§ª GET TEST STOCKS HELPER - SESSION #310 BACKWARD COMPATIBILITY
 * ğŸ¯ PURPOSE: Provide TEST_STOCKS constant replacement for main processing loop
 * ğŸ›¡ï¸ ANTI-REGRESSION: Maintains exact return value expected by index.ts
 */
export function getTestStocks(): string[] {
  return globalScanningConfig.getTestStocks();
}

/**
 * ğŸ”§ GET TIMEFRAME CONFIG HELPER - SESSION #310 BACKWARD COMPATIBILITY
 * ğŸ¯ PURPOSE: Provide TIMEFRAME_CONFIG constant replacement for main processing loop
 * ğŸ›¡ï¸ ANTI-REGRESSION: Maintains exact return value expected by index.ts
 */
export function getTimeframeConfig(): Record<string, TimeframeConfig> {
  return globalScanningConfig.getTimeframeConfig();
}

/**
 * ğŸš€ GET DATE RANGES HELPER - SESSION #310 BACKWARD COMPATIBILITY
 * ğŸ¯ PURPOSE: Provide getDateRanges() function replacement for main processing loop
 * ğŸ›¡ï¸ ANTI-REGRESSION: Maintains exact return value expected by index.ts
 */
export function getDateRanges(): { recent: { start: string; end: string } } {
  return globalScanningConfig.getDateRanges();
}

// ==================================================================================
// ğŸ¯ SESSION #310 SCANNING CONFIGURATION EXTRACTION COMPLETE
// ==================================================================================
// ğŸ“Š FUNCTIONALITY: Complete scanning and timeframe configuration with Session #151-185 preservation + Session #310 modular architecture integration
// ğŸ›¡ï¸ PRESERVATION: Session #185 400-day range + Session #151-185 timeframe weights + Session #152 backtest mode + Session #153 test stocks + all configuration maintained exactly
// ğŸ”§ EXTRACTION SUCCESS: Moved from monolithic function constants to isolated, configurable module following Session #301-309B patterns
// ğŸ“ˆ CONFIGURATION MANAGEMENT: Maintains exact scanning logic through helper functions for main processing loop compatibility + AI optimization ready
// ğŸ–ï¸ ANTI-REGRESSION: All existing configuration logic preserved exactly - scanning requirements identical to original function + all Session #151-185 functionality maintained
// âš¡ MODULAR BENEFITS: Isolated configuration + AI optimization ready + clean interfaces + professional architecture + future enhancement ready + Session #301-309B pattern compliance
// ğŸš€ PRODUCTION READY: Session #310 Scanning Configuration extraction complete - maintains institutional-grade scanning standards with modular architecture advantages + AI optimization capability
// ğŸ”„ NEXT MODULE: Create stock-universe.ts configuration or integrate Session #310 scanning configuration
// ğŸ† TESTING VALIDATION: Extracted Scanning Configuration module must produce identical configuration values (100% exact settings) to original monolithic function constants + maintain all Session #151-185 functionality
// ğŸ¯ SESSION #310A ACHIEVEMENT: Scanning Configuration successfully extracted with 100% functionality preservation + Session #151-185 institutional standards + AI optimization foundation + modular architecture enhanced (8/9 major extractions approaching completion)
// ==================================================================================
